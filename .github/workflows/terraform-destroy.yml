name: Selective Infrastructure Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options:
        - dev
        - staging
        - prod
      server_ip:
        description: 'PUBLIC IP of VPN Server to destroy'
        required: true
        type: string
        placeholder: 'e.g., 54.210.123.45'

jobs:
  selective-destroy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.7.5

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Validate IP format
      run: |
        SERVER_IP="${{ github.event.inputs.server_ip }}"
        if ! echo "$SERVER_IP" | grep -Eq '^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$'; then
          echo "ERROR: Invalid IP address format: $SERVER_IP"
          exit 1
        fi
        echo "Valid IP format: $SERVER_IP"

    - name: Find instance by IP
      id: find_instance
      run: |
        SERVER_IP="${{ github.event.inputs.server_ip }}"

        INSTANCE_ID=$(aws ec2 describe-instances \
          --filters "Name=ip-address,Values=$SERVER_IP" "Name=public-ip-address,Values=$SERVER_IP" \
          --query 'Reservations[].Instances[].InstanceId' \
          --output text)

        if [ -z "$INSTANCE_ID" ]; then
          echo "ERROR: No running instance found with public IP: $SERVER_IP"
          exit 1
        fi

        INSTANCE_NAME=$(aws ec2 describe-instances \
          --instance-ids $INSTANCE_ID \
          --query 'Reservations[0].Instances[0].Tags[?Key==`Name`].Value|[0]' \
          --output text)

        echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
        echo "instance_name=$INSTANCE_NAME" >> $GITHUB_OUTPUT
        echo "Found instance: $INSTANCE_NAME ($INSTANCE_ID)"

    - name: Get security group from instance
      id: get_sg
      run: |
        SG_ID=$(aws ec2 describe-instances \
          --instance-ids ${{ steps.find_instance.outputs.instance_id }} \
          --query 'Reservations[0].Instances[0].SecurityGroups[0].GroupId' \
          --output text)
        echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT

    - name: Destroy EC2 instance via AWS CLI
      if: steps.find_instance.outputs.instance_id != '' && steps.find_instance.outputs.instance_id != 'null'
      run: |
        aws ec2 terminate-instances --instance-ids ${{ steps.find_instance.outputs.instance_id }}
        echo "EC2 termination initiated"

    - name: Wait before SG deletion
      run: sleep 5

    - name: Destroy security group via AWS CLI
      if: steps.get_sg.outputs.sg_id != '' && steps.get_sg.outputs.sg_id != 'null'
      run: |
        aws ec2 delete-security-group --group-id ${{ steps.get_sg.outputs.sg_id }} || true
        echo "Security Group deletion attempted"

    - name: Remove destroyed resources from Terraform state
      run: |
        terraform init
        terraform state list
        terraform state rm module.vpn_server.aws_instance.vpn_server || true
        terraform state rm module.vpn_server.aws_security_group.vpn_sg || true
        terraform state rm module.vpn_server.aws_key_pair.vpn_key || true

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

    - name: Send Telegram notification
      uses: appleboy/telegram-action@v1.0.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸ—‘ï¸ Selective Destroy Completed via AWS CLI!

          ğŸ”§ Environment: ${{ github.event.inputs.environment }}
          ğŸ–¥ï¸ Instance: ${{ steps.find_instance.outputs.instance_id }}
          ğŸŒ Public IP: ${{ github.event.inputs.server_ip }}
          ğŸ·ï¸ Name: ${{ steps.find_instance.outputs.instance_name }}

          âŒ Resources DESTROYED:
          ${{ steps.find_instance.outputs.instance_id && 'â€¢ EC2 Instance' || '' }}
          ${{ steps.get_sg.outputs.sg_id && 'â€¢ Security Group' || '' }}
          â€¢ Key Pair (state only)

          âœ… Resources PRESERVED:
          â€¢ S3 Bucket
          â€¢ DynamoDB Table

          â° Time: ${{ steps.date.outputs.date }}
