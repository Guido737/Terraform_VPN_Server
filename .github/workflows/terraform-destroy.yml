name: Selective Infrastructure Destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment'
        required: true
        default: 'prod'
        type: choice
        options:
        - dev
        - staging
        - prod

jobs:
  selective-destroy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.7.5

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Download Terraform state
      run: |
        aws s3 cp s3://my-vpn-configs-usernamezero-2025/terraform/state/terraform.tfstate ./tfstate.json

    - name: Get instance ID from state file
      id: get_instance
      run: |
        INSTANCE_ID=$(jq -r '.resources[] | select(.type=="aws_instance") | .instances[0].attributes.id' tfstate.json 2>/dev/null || true)
        echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

    - name: Destroy EC2 instance via AWS CLI
      if: steps.get_instance.outputs.instance_id != '' && steps.get_instance.outputs.instance_id != 'null'
      run: |
        aws ec2 terminate-instances --instance-ids ${{ steps.get_instance.outputs.instance_id }}
        echo "EC2 termination initiated"

    - name: Get security group ID
      id: get_sg
      run: |
        SG_ID=$(jq -r '.resources[] | select(.type=="aws_security_group") | .instances[0].attributes.id' tfstate.json 2>/dev/null || true)
        echo "sg_id=$SG_ID" >> $GITHUB_OUTPUT

    - name: Destroy security group via AWS CLI
      if: steps.get_sg.outputs.sg_id != '' && steps.get_sg.outputs.sg_id != 'null'
      run: |
        aws ec2 delete-security-group --group-id ${{ steps.get_sg.outputs.sg_id }} || true
        echo "Security Group deletion attempted"

    - name: Remove destroyed resources from Terraform state
      run: |
        terraform init
        terraform state rm module.vpn_server.aws_instance.vpn_server || true
        terraform state rm module.vpn_server.aws_security_group.vpn_sg || true
        terraform state rm module.vpn_server.aws_key_pair.vpn_key || true

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_OUTPUT

    - name: Send Telegram notification
      uses: appleboy/telegram-action@v1.0.0
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          ğŸ—‘ï¸ Selective Destroy Completed via AWS CLI!

          ğŸ”§ Environment: ${{ github.event.inputs.environment }}

          âŒ Resources DESTROYED:
          ${{ steps.get_instance.outputs.instance_id && 'â€¢ EC2 Instance' || '' }}
          ${{ steps.get_sg.outputs.sg_id && 'â€¢ Security Group' || '' }}
          â€¢ Key Pair (state only)

          âœ… Resources PRESERVED:
          â€¢ S3 Bucket
          â€¢ DynamoDB Table

          â° Time: ${{ steps.date.outputs.date }}
